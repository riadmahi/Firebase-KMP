name: Release Libraries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Update version in gradle.properties
        run: |
          sed -i '' "s/^VERSION_NAME=.*/VERSION_NAME=${{ inputs.version }}/" gradle.properties

      - name: Decode GPG Key
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | base64 --decode > $HOME/secring.gpg

      - name: Publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-configuration-cache

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "libs-v${{ inputs.version }}" -m "Release libraries v${{ inputs.version }}"
          git push origin "libs-v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: libs-v${{ inputs.version }}
          name: Libraries v${{ inputs.version }}
          body: |
            ## Firebase KMP Libraries v${{ inputs.version }}

            ### Installation

            Add to your `build.gradle.kts`:

            ```kotlin
            // Core (required)
            implementation("com.riadmahi.firebase:firebase-core:${{ inputs.version }}")

            // Auth
            implementation("com.riadmahi.firebase:firebase-auth:${{ inputs.version }}")

            // Firestore
            implementation("com.riadmahi.firebase:firebase-firestore:${{ inputs.version }}")

            // Storage
            implementation("com.riadmahi.firebase:firebase-storage:${{ inputs.version }}")

            // Messaging
            implementation("com.riadmahi.firebase:firebase-messaging:${{ inputs.version }}")

            // Analytics
            implementation("com.riadmahi.firebase:firebase-analytics:${{ inputs.version }}")

            // Remote Config
            implementation("com.riadmahi.firebase:firebase-remoteconfig:${{ inputs.version }}")

            // Crashlytics
            implementation("com.riadmahi.firebase:firebase-crashlytics:${{ inputs.version }}")
            ```
          generate_release_notes: true
