name: Release Libraries

on:
  push:
    tags:
      - 'libs-v*'

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/libs-v}" >> $GITHUB_OUTPUT

      - name: Update version in gradle.properties
        run: |
          sed -i '' "s/^VERSION_NAME=.*/VERSION_NAME=${{ steps.version.outputs.VERSION }}/" gradle.properties

      - name: Decode GPG Key
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | base64 --decode > $HOME/secring.gpg

      - name: Publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-configuration-cache

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Libraries v${{ steps.version.outputs.VERSION }}
          body: |
            ## Firebase KMP Libraries v${{ steps.version.outputs.VERSION }}

            ### Installation

            Add to your `build.gradle.kts`:

            ```kotlin
            // Core (required)
            implementation("com.riadmahi.firebase:firebase-core:${{ steps.version.outputs.VERSION }}")

            // Auth
            implementation("com.riadmahi.firebase:firebase-auth:${{ steps.version.outputs.VERSION }}")

            // Firestore
            implementation("com.riadmahi.firebase:firebase-firestore:${{ steps.version.outputs.VERSION }}")

            // Storage
            implementation("com.riadmahi.firebase:firebase-storage:${{ steps.version.outputs.VERSION }}")

            // Messaging
            implementation("com.riadmahi.firebase:firebase-messaging:${{ steps.version.outputs.VERSION }}")

            // Analytics
            implementation("com.riadmahi.firebase:firebase-analytics:${{ steps.version.outputs.VERSION }}")

            // Remote Config
            implementation("com.riadmahi.firebase:firebase-remoteconfig:${{ steps.version.outputs.VERSION }}")

            // Crashlytics
            implementation("com.riadmahi.firebase:firebase-crashlytics:${{ steps.version.outputs.VERSION }}")
            ```
          generate_release_notes: true
